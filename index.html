<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Live Admin Control</title>
    
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    
    <style>
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background-color: #0a0a0a; color: #eee;
            display: flex; flex-direction: column;
            align-items: center;    
            overflow-x: hidden; overflow-y: auto; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .card { 
            background: #000; padding: 0; border-radius: 0; 
            width: 100%; max-width: 650px; box-sizing: border-box;
            border-bottom: 2px solid #222; z-index: 10;
            position: relative; aspect-ratio: 16/9;
        }
        
        #myPlayer, #ytPlayer { width: 100%; height: 100%; display: block; background: #000; border:none; }
        #ytPlayer { position: absolute; top: 0; left: 0; display: none; }

        #admin { display: none; width: 95%; max-width: 650px; margin-top: 15px; }
        
        input { 
            width: 100%; padding: 12px; margin: 6px 0; 
            border: 1px solid #333; border-radius: 8px; 
            font-size: 14px; background: #151515; color: #fff;
            box-sizing: border-box; outline: none;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« */
        #ytResults {
            background: #111; border-radius: 8px; margin: 5px 0;
            max-height: 300px; overflow-y: auto; display: none;
            border: 1px solid #333;
        }
        .yt-res-item {
            padding: 10px; border-bottom: 1px solid #222; cursor: pointer;
            display: flex; align-items: center; gap: 10px;
        }
        .yt-res-item:hover { background: #222; }
        .yt-res-item img { width: 80px; border-radius: 4px; }
        .yt-res-title { font-size: 13px; flex: 1; }

        .btn-group { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }

        button { 
            flex: 1; min-width: 100px; padding: 12px; background-color: #222; 
            color: #fff; border: 1px solid #333; border-radius: 8px; 
            cursor: pointer; font-size: 14px; font-weight: bold;
        }

        .btn-sync.active { background-color: #1b5e20; border-color: #2e7d32; }
        .btn-sync.inactive { background-color: #b71c1c; border-color: #c62828; }
        .btn-delete { color: #ff5252; border-color: #5d1b1b; }

        #statusText { text-align: center; font-size: 13px; color: #4caf50; margin: 10px 0; font-weight: bold; display:none; }
        
        #librarySection {
            width: 95%; max-width: 650px; 
            margin: 20px 0 50px 0; 
            background: #111; border-radius: 12px; border: 1px solid #222;
            padding: 15px; box-sizing: border-box; display: none;
        }
        
        .ep-list { max-height: 500px; overflow-y: auto; }
        
        .ep-item { 
            display: flex; align-items: center; 
            background: #1a1a1a; margin-bottom: 8px; border-radius: 10px;
            border: 1px solid #282828; overflow: hidden;
            flex-direction: row-reverse;
        }
        
        .ep-name-clickable {
            flex-grow: 1; padding: 15px; cursor: pointer; text-align: right;
        }

        .ep-name-text { color: #e0e0e0; font-size: 15px; pointer-events: none; }

        .lib-control-btn {
            background: transparent; border: none; height: 50px; 
            font-size: 18px; cursor: pointer; flex-shrink: 0; padding: 0 12px;
        }
        .single-delete-btn { color: #ff4444; }
        .single-edit-btn { color: #4caf50; }
    </style>
</head>
<body>

    <div class="card">
        <video id="myPlayer" controls autoplay playsinline></video>
        <div id="ytPlayer"></div>
    </div>

    <div id="admin">
        <div style="background: #1a1a1a; padding: 10px; border-radius: 10px; margin-bottom: 10px;">
            <input type="text" id="ytSearchInput" placeholder="Ø¨Ø­Ø« ÙÙŠ ÙŠÙˆØªÙŠÙˆØ¨ ÙˆØªØ´ØºÙŠÙ„ Ù…Ø¨Ø§Ø´Ø±..." onkeypress="if(event.key==='Enter') searchYouTube()">
            <div id="ytResults"></div>
        </div>

        <input type="text" id="urlInput" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ..." onpaste="handlePaste(event)">
        
        <div style="border-top: 1px solid #222; margin-top: 15px; padding-top: 10px;">
            <input type="text" id="epNameInput" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…Ù„ / Ø§Ù„Ø­Ù„Ù‚Ø©">
            <input type="text" id="epUrlInput" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±...">
            <button style="background: #2563eb; color: white; width: 100%; border: none; margin-top: 5px;" onclick="addEpisode()">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ÙƒØªØ¨Ø© +</button>
        </div>

        <div class="btn-group" style="margin-top: 15px; border-top: 1px solid #222; padding-top: 10px;">
            <button id="syncToggleBtn" class="btn-sync" onclick="toggleSync()">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</button>
            <button class="btn-delete" onclick="deleteVideo()">Ø­Ø°Ù ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø¨Ø« ğŸ—‘ï¸</button>
        </div>
        <div id="statusText"></div>
    </div>

    <div id="librarySection">
        <div id="episodesContainer" class="ep-list"></div>
    </div>

    <script>
        var videoElement = document.getElementById('myPlayer');
        var ytContainer = document.getElementById('ytPlayer');
        var ytPlayer;
        var hls = new Hls();
        var dbBaseUrl = "https://videos-5e336-default-rtdb.firebaseio.com/live_stream";
        var dbUrl = dbBaseUrl + ".json";
        var lastUrl = ""; 
        var isAdmin = window.location.hash === "#ana";
        var isSyncEnabled = true;

        // ØªÙ‡ÙŠØ¦Ø© ÙŠÙˆØªÙŠÙˆØ¨
        function onYouTubeIframeAPIReady() {
            ytPlayer = new YT.Player('ytPlayer', {
                events: { 'onStateChange': function(e) { if(isAdmin) updateDatabaseState(); } }
            });
        }

        // Ø¨Ø­Ø« ÙŠÙˆØªÙŠÙˆØ¨ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
        async function searchYouTube() {
            var q = document.getElementById('ytSearchInput').value;
            if(!q) return;
            var resBox = document.getElementById('ytResults');
            resBox.innerHTML = "<div style='padding:10px; text-align:center;'>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</div>";
            resBox.style.display = "block";

            try {
                const response = await fetch(`https://pipedapi.kavin.rocks/search?q=${encodeURIComponent(q)}&filter=videos`);
                const data = await response.json();
                let html = "";
                data.content.forEach(v => {
                    let vidId = v.url.split('v=')[1];
                    html += `<div class="yt-res-item" onclick="forcePlayYT('${vidId}')">
                        <img src="${v.thumbnail}">
                        <div class="yt-res-title">${v.title}</div>
                    </div>`;
                });
                resBox.innerHTML = html;
            } catch(e) { resBox.innerHTML = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„"; }
        }

        function forcePlayYT(id) {
            var fullUrl = "https://www.youtube.com/watch?v=" + id;
            updateDB({ url: fullUrl, status: "playing", time: 0 });
            document.getElementById('ytResults').style.display = "none";
            document.getElementById('ytSearchInput').value = "";
            playMedia(fullUrl);
        }

        function playMedia(url) {
            if (!url) { 
                videoElement.src = ""; videoElement.style.display="block";
                ytContainer.style.display="none"; lastUrl = ""; return; 
            }
            if (url === lastUrl) return;
            lastUrl = url;

            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                var vidId = url.includes('v=') ? url.split('v=')[1].split('&')[0] : url.split('/').pop();
                videoElement.style.display = "none";
                ytContainer.style.display = "block";
                videoElement.pause();
                ytPlayer.loadVideoById(vidId);
            } else {
                ytContainer.style.display = "none";
                videoElement.style.display = "block";
                if(ytPlayer && ytPlayer.pauseVideo) ytPlayer.pauseVideo();
                if (Hls.isSupported() && url.includes('m3u8')) {
                    hls.destroy(); hls = new Hls();
                    hls.loadSource(url); hls.attachMedia(videoElement);
                } else { videoElement.src = url; }
                videoElement.play().catch(e => {});
            }
        }

        // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        function updateDB(data) {
            var xhr = new XMLHttpRequest();
            xhr.open("PATCH", dbUrl, true);
            xhr.send(JSON.stringify(data));
        }

        function renderLibrary(libData) {
            var container = document.getElementById('episodesContainer');
            container.innerHTML = "";
            if (!libData) { container.innerHTML = "<div style='text-align:center; padding:20px; color:#666;'>Ø§Ù„Ù…ÙƒØªØ¨Ø© ÙØ§Ø±ØºØ©</div>"; return; }
            
            Object.keys(libData).forEach(function(key) {
                var ep = libData[key];
                var item = document.createElement('div');
                item.className = "ep-item";
                
                var nameBox = document.createElement('div');
                nameBox.className = "ep-name-clickable";
                nameBox.innerHTML = '<span class="ep-name-text">' + ep.name + '</span>';
                nameBox.onclick = function() { 
                    if (isAdmin) updateDB({ url: ep.url, status: "playing", time: 0 });
                    playMedia(ep.url); 
                };

                if (isAdmin) {
                    var delBtn = document.createElement('button');
                    delBtn.className = "lib-control-btn single-delete-btn";
                    delBtn.innerHTML = "âœ•";
                    delBtn.onclick = function(e) { e.stopPropagation(); deleteSingleEpisode(key); };
                    
                    var editBtn = document.createElement('button');
                    editBtn.className = "lib-control-btn single-edit-btn";
                    editBtn.innerHTML = "âœï¸";
                    editBtn.onclick = function(e) { e.stopPropagation(); editSingleEpisode(key, ep.name, ep.url); };

                    item.appendChild(delBtn);
                    item.appendChild(editBtn);
                }
                item.appendChild(nameBox);
                container.appendChild(item);
            });
        }

        function editSingleEpisode(key, oldName, oldUrl) {
            var n = prompt("Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:", oldName);
            var u = prompt("Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯:", oldUrl);
            if (n && u) {
                var xhr = new XMLHttpRequest();
                xhr.open("PATCH", dbBaseUrl + "/library/" + key + ".json", true);
                xhr.onload = function() { loadStream(); };
                xhr.send(JSON.stringify({ name: n, url: u }));
            }
        }

        function deleteSingleEpisode(key) {
            if(confirm("Ø­Ø°ÙØŸ")) {
                var xhr = new XMLHttpRequest();
                xhr.open("DELETE", dbBaseUrl + "/library/" + key + ".json", true);
                xhr.onload = function() { loadStream(); };
                xhr.send();
            }
        }

        function syncPlayer(data) {
            if (!data) return;
            isSyncEnabled = data.syncEnabled !== false; 
            updateSyncButtonUI();

            var lib = document.getElementById('librarySection');
            if (isAdmin || !isSyncEnabled) {
                lib.style.display = "block";
                renderLibrary(data.library);
            } else { lib.style.display = "none"; }

            if (isSyncEnabled && !isAdmin) {
                if (data.url !== lastUrl) playMedia(data.url);
                var cur = data.url.includes('youtube') ? ytPlayer.getCurrentTime() : videoElement.currentTime;
                if (Math.abs(cur - data.time) > 4) {
                    if(data.url.includes('youtube')) ytPlayer.seekTo(data.time);
                    else videoElement.currentTime = data.time;
                }
            }
        }

        function loadStream() {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", dbUrl, true);
            xhr.onload = function () { if (xhr.status === 200) syncPlayer(JSON.parse(xhr.responseText)); };
            xhr.send();
        }

        function toggleSync() {
            if (!isAdmin) return;
            isSyncEnabled = !isSyncEnabled;
            updateDB({ syncEnabled: isSyncEnabled });
            updateSyncButtonUI();
        }

        function updateSyncButtonUI() {
            var btn = document.getElementById('syncToggleBtn');
            btn.innerText = isSyncEnabled ? "Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: Ù…ÙØ¹Ù„Ø© âœ…" : "Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: Ù…Ø¹Ø·Ù„Ø© âŒ";
            btn.className = "btn-sync " + (isSyncEnabled ? "active" : "inactive");
        }

        function addEpisode() {
            var name = document.getElementById('epNameInput').value;
            var url = document.getElementById('epUrlInput').value;
            if (name && url) {
                var xhr = new XMLHttpRequest();
                xhr.open("POST", dbBaseUrl + "/library.json", true);
                xhr.onload = function() {
                    document.getElementById('epNameInput').value = "";
                    document.getElementById('epUrlInput').value = "";
                    loadStream();
                };
                xhr.send(JSON.stringify({ name: name, url: url }));
            }
        }

        function updateDatabaseState() {
            if (!isAdmin || !isSyncEnabled) return;
            var t = lastUrl.includes('youtube') ? ytPlayer.getCurrentTime() : videoElement.currentTime;
            var s = lastUrl.includes('youtube') ? (ytPlayer.getPlayerState()===1?"playing":"paused") : (videoElement.paused?"paused":"playing");
            updateDB({ status: s, time: t || 0 });
        }

        setInterval(function() {
            loadStream();
            if (isAdmin && isSyncEnabled) updateDatabaseState();
        }, 3000);

        function handlePaste(event) {
            setTimeout(function() {
                var val = document.getElementById('urlInput').value.trim();
                if (val) {
                    updateDB({ url: val, status: "playing", time: 0 });
                    document.getElementById('urlInput').value = ''; 
                    playMedia(val);
                }
            }, 100);
        }

        function deleteVideo() {
            if(confirm("Ø­Ø°Ù Ø§Ù„Ø¨Ø«ØŸ")) updateDB({ url: "", status: "paused", time: 0 });
        }

        window.onload = function() {
            loadStream();
            if(isAdmin) document.getElementById('admin').style.display = "block";
        };
    </script>
</body>
</html>
